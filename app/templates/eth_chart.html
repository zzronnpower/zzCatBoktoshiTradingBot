<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ASTER Chart - zzCatBoktoshiTradingBot</title>
    <link rel="stylesheet" href="/static/app.css" />
    <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
      .trading-shell { display: grid; grid-template-columns: 1fr 340px; gap: 12px; }
      .top-ticker { display: grid; grid-template-columns: repeat(6, minmax(110px, 1fr)); gap: 8px; margin-bottom: 12px; }
      .tk { border: 1px solid var(--line); border-radius: 10px; padding: 10px; background: linear-gradient(180deg, var(--chart-card-1), var(--chart-card-2)); }
      .tk .k { display:block; color: var(--muted); font-size:11px; text-transform:uppercase; letter-spacing:.6px; margin-bottom:6px; }
      .tk .v { font-size:18px; font-weight:700; }
      #tk-oi { white-space: nowrap; }
      .chart-card { min-height: 620px; }
      .chart-toolbar { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:10px; flex-wrap: wrap; }
      .overlay-note { color: var(--muted); font-size: 12px; }
      .symbol-group { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      .symbol-group input, .symbol-group select {
        border: 1px solid var(--line);
        background: var(--input-bg);
        color: var(--text);
        border-radius: 8px;
        padding: 8px 10px;
      }
      .symbol-group select {
        color-scheme: dark;
        background: linear-gradient(180deg, var(--chart-select-1) 0%, var(--chart-select-2) 100%);
      }
      .symbol-group select option {
        background: var(--chart-select-option);
        color: var(--text);
      }
      .symbol-group input { width: 170px; }
      .symbol-group select { width: 170px; }
      .tf-group { display:flex; gap:6px; flex-wrap:wrap; }
      .tf-btn { border:1px solid var(--line); background:rgba(255,255,255,.04); color:var(--text); padding:6px 10px; border-radius:8px; cursor:pointer; }
      .tf-btn.active { border-color: var(--accent); color: var(--accent); }
      #chart { width:100%; height:520px; border:1px solid var(--line); border-radius:10px; overflow:hidden; }
      .book-card { min-height: 620px; }
      .book-head, .book-row { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; padding:7px 8px; font-size:13px; }
      .book-head { color: var(--muted); text-transform:uppercase; font-size:11px; border-bottom:1px solid var(--line); }
      .book-wrap { border:1px solid var(--line); border-radius:10px; overflow:hidden; }
      .book-row { position:relative; border-bottom:1px solid rgba(255,255,255,.04); }
      .book-row:last-child { border-bottom:none; }
      .book-row .heat { position:absolute; inset:0; opacity:.15; pointer-events:none; }
      .book-row.ask .heat { background: linear-gradient(90deg, rgba(255,105,120,0) 0%, rgba(255,105,120,.8) 100%); }
      .book-row.bid .heat { background: linear-gradient(90deg, rgba(98,220,164,0) 0%, rgba(98,220,164,.8) 100%); }
      .ask-px { color:#ff9da8; }
      .bid-px { color:#84e8b5; }
      .spread { padding:8px; text-align:center; color:var(--muted); border-top:1px solid var(--line); border-bottom:1px solid var(--line); background:rgba(0,0,0,.2); }
      .live-mini { color: var(--muted); font-size:12px; }
      .mini-ok { color: #89e6a8; }
      .mini-warn { color: #ffd88f; }
      .mini-err { color: #ff9da8; }
      @media (max-width: 1200px) { .trading-shell { grid-template-columns: 1fr; } }
    </style>
  </head>
  <body>
    <div class="page">
      <header class="header">
        <h1>ASTER Chart</h1>
        <p>Live futures chart and orderbook with ASTER USDT symbols.</p>
        <div class="nav-links">
          <a href="/">Dashboard</a>
          <a href="/manual">Manual Trade</a>
          <a href="/aster-chart" class="active">ASTER Chart</a>
          <a href="/aster-trading">AsterTrading</a>
          <a href="/chatlog">ChatLog</a>
        </div>
      </header>

      <section class="top-ticker">
        <div class="tk"><span class="k">Symbol</span><span class="v" id="tk-symbol">ETHUSDT</span></div>
        <div class="tk"><span class="k">Mark</span><span class="v" id="tk-mark">-</span></div>
        <div class="tk"><span class="k">Index</span><span class="v" id="tk-index">-</span></div>
        <div class="tk"><span class="k">24h Change</span><span class="v" id="tk-change">-</span></div>
        <div class="tk"><span class="k">24h Volume</span><span class="v" id="tk-vol">-</span></div>
        <div class="tk"><span class="k">OI / Funding</span><span class="v" id="tk-oi">-</span></div>
      </section>

      <section class="trading-shell">
        <div class="card chart-card">
          <div class="chart-toolbar">
            <div class="symbol-group">
              <input id="symbol-search" type="text" placeholder="Search USDT symbol" />
              <select id="symbol-select"></select>
            </div>
            <div class="tf-group" id="tf-group">
              <button class="tf-btn" data-tf="1m">1m</button>
              <button class="tf-btn active" data-tf="5m">5m</button>
              <button class="tf-btn" data-tf="15m">15m</button>
              <button class="tf-btn" data-tf="1h">1h</button>
              <button class="tf-btn" data-tf="4h">4h</button>
              <button class="tf-btn" data-tf="1d">1d</button>
            </div>
            <div class="overlay-note" id="overlay-status">Strategy overlay: loading...</div>
            <div class="live-mini" id="chart-status">Loading...</div>
          </div>
          <div id="chart"></div>
        </div>

        <div class="card book-card">
          <h2>Order Book</h2>
          <div class="live-mini" id="book-status">Connecting...</div>
          <div class="book-wrap">
            <div class="book-head"><span>Price</span><span>Size</span><span>Total</span></div>
            <div id="asks"></div>
            <div class="spread" id="spread">Spread: -</div>
            <div id="bids"></div>
          </div>
        </div>
      </section>
    </div>

    <script>
      let selectedSymbol = 'ETHUSDT';
      let allSymbols = [];
      let timeframe = '5m';
      let nextFundingTime = 0;
      let chart;
      let candleSeries;
      let volumeSeries;
      let ma50Series;
      let emaFastSeries;
      let emaSlowSeries;
      let entryPriceLine;
      let stopLossLine;
      let takeProfitLine;
      let inFlightKline = false;
      let inFlightDepth = false;
      let inFlightOverlay = false;
      let depthSocket = null;
      let wsReconnectTimer = null;
      let wsBackoffMs = 1000;
      let wsConnected = false;
      let wsStreamSymbol = '';
      let lastWsDepthAt = 0;

      const nf = (n, max = 2) => Number(n || 0).toLocaleString('en-US', { maximumFractionDigits: max });
      const money = (n) => nf(n, 2);
      const pct = (n) => `${Number(n || 0).toFixed(3)}%`;
      const fmtLarge = (n) => {
        const v = Number(n || 0);
        if (v >= 1_000_000_000) return `${(v / 1_000_000_000).toFixed(2)}B`;
        if (v >= 1_000_000) return `${(v / 1_000_000).toFixed(2)}M`;
        if (v >= 1_000) return `${(v / 1_000).toFixed(2)}K`;
        return nf(v, 2);
      };

      async function fetchJson(path, timeoutMs = 5000) {
        const ctrl = new AbortController();
        const t = setTimeout(() => ctrl.abort(), timeoutMs);
        const res = await fetch(path, { cache: 'no-store', signal: ctrl.signal });
        clearTimeout(t);
        if (!res.ok) throw new Error(`${path} failed: ${res.status}`);
        return res.json();
      }

      function buildChart() {
        const el = document.getElementById('chart');
        const styles = getComputedStyle(document.documentElement);
        const chartBg = styles.getPropertyValue('--chart-bg').trim() || '#0d1627';
        const chartGrid = styles.getPropertyValue('--chart-grid').trim() || 'rgba(255, 255, 255, 0.06)';
        const chartText = styles.getPropertyValue('--text').trim() || '#c8d4e3';
        const chartLine = styles.getPropertyValue('--line').trim() || 'rgba(255, 255, 255, 0.08)';
        const chartUp = styles.getPropertyValue('--chart-up').trim() || '#62dca4';
        const chartDown = styles.getPropertyValue('--chart-down').trim() || '#ff6b7d';
        chart = LightweightCharts.createChart(el, {
          layout: { background: { type: 'solid', color: chartBg }, textColor: chartText },
          grid: { vertLines: { color: chartGrid }, horzLines: { color: chartGrid } },
          rightPriceScale: { borderColor: chartLine },
          timeScale: { borderColor: chartLine, timeVisible: true, secondsVisible: false },
          crosshair: { mode: 1 },
        });
        candleSeries = chart.addCandlestickSeries({
          upColor: chartUp, downColor: chartDown, borderUpColor: chartUp, borderDownColor: chartDown, wickUpColor: chartUp, wickDownColor: chartDown,
        });
        ma50Series = chart.addLineSeries({
          color: '#f3c969',
          lineWidth: 2,
          priceLineVisible: false,
          lastValueVisible: true,
        });
        emaFastSeries = chart.addLineSeries({
          color: '#7ec8ff',
          lineWidth: 2,
          priceLineVisible: false,
          lastValueVisible: true,
        });
        emaSlowSeries = chart.addLineSeries({
          color: '#ffb86f',
          lineWidth: 2,
          priceLineVisible: false,
          lastValueVisible: true,
        });
        volumeSeries = chart.addHistogramSeries({
          color: '#3c7cf5',
          priceFormat: { type: 'volume' },
          priceScaleId: '',
        });
        volumeSeries.priceScale().applyOptions({
          scaleMargins: { top: 0.82, bottom: 0 },
        });
        window.addEventListener('resize', () => {
          chart.applyOptions({ width: el.clientWidth, height: 520 });
        });
        window.addEventListener('themechange', () => {
          const s = getComputedStyle(document.documentElement);
          const bg = s.getPropertyValue('--chart-bg').trim() || '#0d1627';
          const g = s.getPropertyValue('--chart-grid').trim() || 'rgba(255,255,255,.06)';
          const t = s.getPropertyValue('--text').trim() || '#c8d4e3';
          const l = s.getPropertyValue('--line').trim() || 'rgba(255,255,255,.08)';
          const up = s.getPropertyValue('--chart-up').trim() || '#62dca4';
          const dn = s.getPropertyValue('--chart-down').trim() || '#ff6b7d';
          const accent = s.getPropertyValue('--accent').trim() || '#f3c969';
          chart.applyOptions({
            layout: { background: { type: 'solid', color: bg }, textColor: t },
            grid: { vertLines: { color: g }, horzLines: { color: g } },
            rightPriceScale: { borderColor: l },
            timeScale: { borderColor: l, timeVisible: true, secondsVisible: false },
          });
          candleSeries.applyOptions({ upColor: up, downColor: dn, borderUpColor: up, borderDownColor: dn, wickUpColor: up, wickDownColor: dn });
          ma50Series.applyOptions({ color: accent });
          emaFastSeries.applyOptions({ color: '#7ec8ff' });
          emaSlowSeries.applyOptions({ color: '#ffb86f' });
        });
      }

      function clearPositionLines() {
        if (entryPriceLine) {
          candleSeries.removePriceLine(entryPriceLine);
          entryPriceLine = null;
        }
        if (stopLossLine) {
          candleSeries.removePriceLine(stopLossLine);
          stopLossLine = null;
        }
        if (takeProfitLine) {
          candleSeries.removePriceLine(takeProfitLine);
          takeProfitLine = null;
        }
      }

      function clearStrategyOverlay(note = '') {
        ma50Series.setData([]);
        emaFastSeries.setData([]);
        emaSlowSeries.setData([]);
        candleSeries.setMarkers([]);
        clearPositionLines();
        if (note) {
          document.getElementById('overlay-status').textContent = note;
        }
      }

      function applyPositionLines(position) {
        clearPositionLines();
        if (!position) return;
        const entry = Number(position.entry_price || 0);
        const sl = Number(position.stop_loss || 0);
        const tp = Number(position.take_profit || 0);
        if (entry > 0) {
          entryPriceLine = candleSeries.createPriceLine({
            price: entry,
            color: '#6fd3a8',
            lineWidth: 1,
            lineStyle: 2,
            axisLabelVisible: true,
            title: 'Entry',
          });
        }
        if (sl > 0) {
          stopLossLine = candleSeries.createPriceLine({
            price: sl,
            color: '#ff8e8e',
            lineWidth: 1,
            lineStyle: 2,
            axisLabelVisible: true,
            title: 'SL',
          });
        }
        if (tp > 0) {
          takeProfitLine = candleSeries.createPriceLine({
            price: tp,
            color: '#ffd88f',
            lineWidth: 1,
            lineStyle: 2,
            axisLabelVisible: true,
            title: 'TP',
          });
        }
      }

      async function refreshStrategyOverlay() {
        if (inFlightOverlay) return;
        if (selectedSymbol !== 'ETHUSDT') {
          clearStrategyOverlay('Strategy overlay: ETHUSDT only');
          return;
        }
        inFlightOverlay = true;
        try {
          const data = await fetchJson(`/api/strategy/overlay?symbol=ETHUSDT&interval=${timeframe}&limit=320`, 9000);
          if (!data.enabled) {
            const required = String(data.required_interval || '').trim();
            const hint = required ? ` | switch timeframe to ${required}` : '';
            clearStrategyOverlay(`Strategy overlay: ${data.message || 'not available'}${hint}`);
            return;
          }
          const maData = Array.isArray(data.ma50) ? data.ma50.map((x) => ({ time: Number(x.time), value: Number(x.value) })) : [];
          const emaFastData = Array.isArray(data.ema_fast) ? data.ema_fast.map((x) => ({ time: Number(x.time), value: Number(x.value) })) : [];
          const emaSlowData = Array.isArray(data.ema_slow) ? data.ema_slow.map((x) => ({ time: Number(x.time), value: Number(x.value) })) : [];
          ma50Series.setData(maData);
          emaFastSeries.setData(emaFastData);
          emaSlowSeries.setData(emaSlowData);

          const entries = Array.isArray(data.entry_markers) ? data.entry_markers : [];
          const entryMarkers = entries.map((m) => ({
            time: Number(m.time),
            position: 'belowBar',
            color: '#6fd3a8',
            shape: 'arrowUp',
            text: String(m.text || 'Entry'),
          }));

          const pos = data.position || null;
          if (pos && Number(pos.opened_at || 0) > 0 && Number(pos.entry_price || 0) > 0) {
            entryMarkers.push({
              time: Number(pos.opened_at),
              position: 'belowBar',
              color: '#9fd9ff',
              shape: 'circle',
              text: `Live ${Number(pos.entry_price).toFixed(2)}`,
            });
          }
          candleSeries.setMarkers(entryMarkers);
          applyPositionLines(pos);

          const strategyId = data.strategy || '-';
          const signalCount = entries.length;
          const required = data.required_interval || data.interval || '-';
          const lineLabel = emaFastData.length || emaSlowData.length ? 'EMA20/EMA50' : 'MA50';
          const statusText = pos
            ? `Strategy overlay: ${strategyId} | ${lineLabel} | ${required} | signals ${signalCount} | position ${pos.position_id || '-'}`
            : `Strategy overlay: ${strategyId} | ${lineLabel} | ${required} | signals ${signalCount} | no open strategy position`;
          document.getElementById('overlay-status').textContent = statusText;
        } catch (e) {
          clearStrategyOverlay(`Strategy overlay delayed (${e})`);
        } finally {
          inFlightOverlay = false;
        }
      }

      function setSymbol(symbol) {
        if (!symbol) return;
        selectedSymbol = symbol.toUpperCase();
        localStorage.setItem('aster_chart_symbol', selectedSymbol);
        document.getElementById('tk-symbol').textContent = selectedSymbol;
      }

      function renderSymbolOptions(filterText = '') {
        const select = document.getElementById('symbol-select');
        const q = filterText.trim().toUpperCase();
        const filtered = allSymbols.filter((s) => (!q ? true : s.includes(q)));
        select.innerHTML = filtered.map((s) => `<option value="${s}">${s}</option>`).join('');
        if (!filtered.includes(selectedSymbol)) {
          setSymbol(filtered[0] || 'ETHUSDT');
        }
        select.value = selectedSymbol;
      }

      async function loadSymbols() {
        const data = await fetchJson('/api/aster/symbols', 8000);
        const items = Array.isArray(data.items) ? data.items : [];
        allSymbols = items.length ? items : ['ETHUSDT'];
        const saved = (localStorage.getItem('aster_chart_symbol') || 'ETHUSDT').toUpperCase();
        setSymbol(allSymbols.includes(saved) ? saved : (allSymbols.includes('ETHUSDT') ? 'ETHUSDT' : allSymbols[0]));
        renderSymbolOptions('');
      }

      async function refreshOverview() {
        const symbol = selectedSymbol;
        const data = await fetchJson(`/api/aster/overview?symbol=${symbol}`);
        if (symbol !== selectedSymbol) return;
        document.getElementById('tk-mark').textContent = money(data.markPrice);
        document.getElementById('tk-index').textContent = money(data.indexPrice);
        const ch = Number(data.priceChangePercent || 0);
        const changeEl = document.getElementById('tk-change');
        changeEl.textContent = `${money(data.priceChange)} / ${pct(ch)}`;
        changeEl.style.color = ch >= 0 ? '#89e6a8' : '#ff9da8';
        document.getElementById('tk-vol').textContent = `${fmtLarge(data.quoteVolume)} USDT`;
        document.getElementById('tk-oi').textContent = `${fmtLarge(data.openInterest)} / ${pct(Number(data.lastFundingRate || 0) * 100)}`;
        nextFundingTime = Number(data.nextFundingTime || 0);
      }

      async function refreshKlines() {
        if (inFlightKline) return;
        inFlightKline = true;
        const symbol = selectedSymbol;
        document.getElementById('chart-status').textContent = `Loading ${symbol} ${timeframe} candles...`;
        try {
          const data = await fetchJson(`/api/aster/klines?symbol=${symbol}&interval=${timeframe}&limit=400`);
          if (symbol !== selectedSymbol) return;
          const items = data.items || [];
          const candles = items.map((k) => ({
            time: Math.floor(Number(k[0]) / 1000),
            open: Number(k[1]),
            high: Number(k[2]),
            low: Number(k[3]),
            close: Number(k[4]),
          }));
          const vols = items.map((k) => ({
            time: Math.floor(Number(k[0]) / 1000),
            value: Number(k[5]),
            color: Number(k[4]) >= Number(k[1]) ? 'rgba(98,220,164,.45)' : 'rgba(255,107,125,.45)',
          }));
          candleSeries.setData(candles);
          volumeSeries.setData(vols);
          chart.timeScale().fitContent();
          const status = document.getElementById('chart-status');
          status.className = 'live-mini mini-ok';
          status.textContent = `Live ${symbol} ${timeframe} - ${new Date().toLocaleTimeString()}`;
        } catch (e) {
          const status = document.getElementById('chart-status');
          status.className = 'live-mini mini-warn';
          status.textContent = `Kline delayed (${e})`;
        } finally {
          inFlightKline = false;
        }
      }

      function renderSide(target, rows, side) {
        const maxSz = Math.max(1, ...rows.map((r) => Number(r[1] || 0)));
        let running = 0;
        const html = rows
          .map((r) => {
            const px = Number(r[0]);
            const sz = Number(r[1]);
            running += sz;
            const heat = Math.min(100, (sz / maxSz) * 100);
            const cls = side === 'ask' ? 'ask-px' : 'bid-px';
            return `<div class="book-row ${side}"><div class="heat" style="width:${heat}%"></div><span class="${cls}">${money(px)}</span><span>${nf(sz,4)}</span><span>${nf(running,4)}</span></div>`;
          })
          .join('');
        target.innerHTML = html;
      }

      function renderDepthBook(asksIn, bidsIn, source = 'rest') {
        const asks = (asksIn || []).slice(0, 10).reverse();
        const bids = (bidsIn || []).slice(0, 10);
        renderSide(document.getElementById('asks'), asks, 'ask');
        renderSide(document.getElementById('bids'), bids, 'bid');
        const bestAsk = asks.length ? Number(asks[asks.length - 1][0]) : 0;
        const bestBid = bids.length ? Number(bids[0][0]) : 0;
        const spread = bestAsk > 0 && bestBid > 0 ? bestAsk - bestBid : 0;
        document.getElementById('spread').textContent = `Spread: ${money(spread)} (${bestBid ? ((spread / bestBid) * 100).toFixed(4) : '0.0000'}%)`;
        const s = document.getElementById('book-status');
        s.className = 'live-mini mini-ok';
        s.textContent = source === 'ws'
          ? `${selectedSymbol} orderbook ws live - ${new Date().toLocaleTimeString()}`
          : `${selectedSymbol} orderbook live - ${new Date().toLocaleTimeString()}`;
      }

      function applyMarkStream(mark) {
        const markPrice = Number(mark.p || mark.markPrice || 0);
        const indexPrice = Number(mark.i || mark.indexPrice || 0);
        const fundingRate = Number(mark.r || mark.lastFundingRate || 0);
        if (markPrice > 0) document.getElementById('tk-mark').textContent = money(markPrice);
        if (indexPrice > 0) document.getElementById('tk-index').textContent = money(indexPrice);
        const oiText = document.getElementById('tk-oi').textContent || '-';
        const oiPrefix = oiText.includes('/') ? oiText.split('/')[0].trim() : oiText;
        document.getElementById('tk-oi').textContent = `${oiPrefix} / ${pct(fundingRate * 100)}`;
      }

      function disconnectDepthStream() {
        if (wsReconnectTimer) {
          clearTimeout(wsReconnectTimer);
          wsReconnectTimer = null;
        }
        if (depthSocket) {
          try {
            depthSocket.onopen = null;
            depthSocket.onmessage = null;
            depthSocket.onerror = null;
            depthSocket.onclose = null;
            depthSocket.close();
          } catch (_) {}
          depthSocket = null;
        }
        wsConnected = false;
      }

      function connectDepthStream() {
        if (selectedSymbol !== 'ETHUSDT' && !selectedSymbol.endsWith('USDT')) {
          disconnectDepthStream();
          return;
        }
        if (depthSocket) {
          disconnectDepthStream();
        }
        const sym = selectedSymbol.toLowerCase();
        wsStreamSymbol = selectedSymbol;
        const streams = `${sym}@depth10@100ms/${sym}@markPrice@1s`;
        const wsUrl = `wss://fstream.asterdex.com/stream?streams=${streams}`;
        const s = document.getElementById('book-status');
        s.className = 'live-mini mini-warn';
        s.textContent = `${selectedSymbol} orderbook connecting websocket...`;

        try {
          depthSocket = new WebSocket(wsUrl);
        } catch (e) {
          wsConnected = false;
          s.className = 'live-mini mini-err';
          s.textContent = `WebSocket unavailable (${e}), using REST fallback`;
          return;
        }

        depthSocket.onopen = () => {
          wsConnected = true;
          wsBackoffMs = 1000;
          const x = document.getElementById('book-status');
          x.className = 'live-mini mini-ok';
          x.textContent = `${selectedSymbol} orderbook websocket connected`;
        };

        depthSocket.onmessage = (event) => {
          let payload;
          try {
            payload = JSON.parse(event.data || '{}');
          } catch (_) {
            return;
          }
          const data = payload && payload.data ? payload.data : payload;
          if (!data || typeof data !== 'object') return;
          const stream = String(payload.stream || '').toLowerCase();
          if (wsStreamSymbol !== selectedSymbol) return;

          if (stream.includes('@depth') || data.e === 'depthUpdate') {
            const asks = Array.isArray(data.asks) ? data.asks : (Array.isArray(data.a) ? data.a : []);
            const bids = Array.isArray(data.bids) ? data.bids : (Array.isArray(data.b) ? data.b : []);
            if (asks.length || bids.length) {
              lastWsDepthAt = Date.now();
              renderDepthBook(asks, bids, 'ws');
            }
            return;
          }

          if (stream.includes('@markprice') || data.e === 'markPriceUpdate') {
            applyMarkStream(data);
          }
        };

        depthSocket.onerror = () => {
          wsConnected = false;
        };

        depthSocket.onclose = () => {
          wsConnected = false;
          depthSocket = null;
          if (wsStreamSymbol !== selectedSymbol) return;
          const x = document.getElementById('book-status');
          x.className = 'live-mini mini-warn';
          x.textContent = `${selectedSymbol} websocket disconnected, retry in ${Math.round(wsBackoffMs / 1000)}s (REST fallback active)`;
          if (wsReconnectTimer) clearTimeout(wsReconnectTimer);
          wsReconnectTimer = setTimeout(() => {
            connectDepthStream();
          }, wsBackoffMs);
          wsBackoffMs = Math.min(wsBackoffMs * 2, 15000);
        };
      }

      async function refreshDepth() {
        if (inFlightDepth) return;
        if (wsConnected && (Date.now() - lastWsDepthAt) < 8000) {
          return;
        }
        inFlightDepth = true;
        const symbol = selectedSymbol;
        try {
          const data = await fetchJson(`/api/aster/depth?symbol=${symbol}&limit=10`);
          if (symbol !== selectedSymbol) return;
          renderDepthBook(data.asks || [], data.bids || [], 'rest');
        } catch (e) {
          const s = document.getElementById('book-status');
          s.className = 'live-mini mini-err';
          s.textContent = `Orderbook unavailable (${e})`;
        } finally {
          inFlightDepth = false;
        }
      }

      function bindTimeframeButtons() {
        const group = document.getElementById('tf-group');
        group.querySelectorAll('.tf-btn').forEach((btn) => {
          btn.addEventListener('click', async () => {
            group.querySelectorAll('.tf-btn').forEach((b) => b.classList.remove('active'));
            btn.classList.add('active');
            timeframe = btn.dataset.tf;
            await refreshKlines();
            await refreshStrategyOverlay();
          });
        });
      }

      function bindSymbolControls() {
        const search = document.getElementById('symbol-search');
        const select = document.getElementById('symbol-select');
        search.addEventListener('input', () => {
          renderSymbolOptions(search.value || '');
        });
        select.addEventListener('change', async () => {
          setSymbol(select.value || 'ETHUSDT');
          connectDepthStream();
          await refreshOverview();
          await refreshKlines();
          await refreshStrategyOverlay();
          await refreshDepth();
        });
      }

      async function boot() {
        buildChart();
        window.addEventListener('beforeunload', () => {
          disconnectDepthStream();
        });
        bindTimeframeButtons();
        bindSymbolControls();
        await loadSymbols();
        await refreshOverview();
        await refreshKlines();
        await refreshStrategyOverlay();
        connectDepthStream();
        await refreshDepth();
        setInterval(() => refreshOverview().catch(() => {}), 3000);
        setInterval(() => refreshDepth().catch(() => {}), 2000);
        setInterval(() => refreshKlines().catch(() => {}), 12000);
        setInterval(() => refreshStrategyOverlay().catch(() => {}), 12000);
      }

      boot().catch((e) => {
        document.getElementById('chart-status').textContent = `Init error: ${e}`;
      });
    </script>
    <script src="/static/theme.js"></script>
  </body>
</html>
