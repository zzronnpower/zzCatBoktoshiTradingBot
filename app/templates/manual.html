<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Manual Trade - zzCatBoktoshiTradingBot</title>
    <link rel="stylesheet" href="/static/app.css" />
  </head>
  <body>
    <div class="page">
      <header class="header">
        <h1>Manual Trade Console</h1>
        <p>Open and close manual LONG positions while strategy remains ETHUSDT-only.</p>
        <div class="nav-links">
          <a href="/">Dashboard</a>
          <a href="/manual" class="active">Manual Trade</a>
          <a href="/aster-chart">ASTER Chart</a>
          <a href="/aster-trading">AsterTrading</a>
          <a href="/chatlog">ChatLog</a>
        </div>
      </header>

      <section class="grid manual-grid">
        <div class="card">
          <h2>Strategy Control</h2>
          <p class="muted">Pause/resume strategy engine and switch active strategy profile.</p>
          <div class="kv-list" style="margin-top:10px;">
            <div class="kv-row">
              <span>Active Strategy</span>
              <select id="strategy-select" style="max-width:300px;"></select>
            </div>
            <div class="kv-row"><span>Strategy Note</span><strong id="strategy-entry-note">Loading...</strong></div>
          </div>
          <button id="btn-apply-strategy" class="btn btn-primary" style="margin-top:10px;">Apply Strategy</button>
          <div class="btn-row">
            <button id="btn-pause" class="btn btn-warning">Pause Running Bot</button>
            <button id="btn-resume" class="btn btn-primary">Resume Bot</button>
          </div>
          <div id="strategy-state" class="muted">Strategy state: loading...</div>
        </div>

        <div class="card">
          <h2>Bot Settings</h2>
          <p class="muted">Edit shared settings used by Strategy and Manual open trade flow.</p>
          <div class="kv-list" style="margin-top:10px;">
            <div class="kv-row"><span>Margin (BOKS)</span><input id="cfg-size" type="number" min="1" step="1" style="max-width:140px;" /></div>
            <div class="kv-row"><span>Leverage (x)</span><input id="cfg-lev" type="number" min="1" step="0.1" style="max-width:140px;" /></div>
            <div class="kv-row"><span>Stoploss (%)</span><input id="cfg-sl" type="number" min="0.01" step="0.01" style="max-width:140px;" /></div>
            <div class="kv-row"><span>Take Profit (%)</span><input id="cfg-tp" type="number" min="0" step="0.01" style="max-width:140px;" /></div>
          </div>
          <button id="btn-save-settings" class="btn btn-primary" style="margin-top:10px;">Save Settings</button>
        </div>

        <div class="card">
          <h2>Manual Trade Panel</h2>
          <p class="muted">Pick a symbol, then open manual LONG with current Bot Settings profile.</p>
          <div class="kv-list" style="margin-top:10px;">
            <div class="kv-row">
              <span>Open LONG Symbol</span>
              <select id="manual-open-symbol" style="max-width:210px;">
                <option value="BTCUSDT">BTCUSDT</option>
                <option value="ETHUSDT">ETHUSDT</option>
                <option value="SOLUSDT">SOLUSDT</option>
                <option value="XRPUSDT">XRPUSDT</option>
                <option value="HYPEUSDT">HYPEUSDT</option>
                <option value="PUMPUSDT">PUMPUSDT</option>
                <option value="DOGEUSDT">DOGEUSDT</option>
              </select>
            </div>
            <div class="kv-row"><span>Config Preview</span><strong id="manual-config-preview">Loading...</strong></div>
          </div>
          <button id="btn-open" class="btn btn-primary" style="margin-top:10px;">OPEN Manual LONG Position</button>
        </div>

        <div class="card">
          <h2>Close Position</h2>
          <p class="muted">Select a manual-owned position and close only that one.</p>
          <div class="kv-list" style="margin-top:10px;">
            <div class="kv-row">
              <span>Manual Position</span>
              <select id="manual-close-position" style="max-width:270px;"></select>
            </div>
          </div>
          <button id="btn-close" class="btn btn-danger" style="margin-top:10px;">Manual Close Position</button>
          <button id="btn-close-strategy" class="btn btn-warning" style="margin-top: 10px;">Close Strategy Position</button>
        </div>
      </section>

      <section class="grid">
        <div class="card">
          <h2>Current Open Positions</h2>
          <p class="muted">Strategy Position</p>
          <div id="positions-strategy">Loading...</div>
          <p class="muted" style="margin-top: 10px;">Manual Position</p>
          <div id="positions-manual">Loading...</div>
        </div>
        <div class="card">
          <h2>Action Result</h2>
          <div id="result" class="kv-list"><div class="kv-row"><span>Status</span><strong>Idle</strong></div></div>
        </div>
      </section>
    </div>

    <script>
      const money = (n) => Number(n || 0).toLocaleString('en-US', { maximumFractionDigits: 2 });
      const tsMs = (ms) => {
        if (!ms) return '-';
        const d = new Date(Number(ms));
        return Number.isNaN(d.getTime()) ? '-' : d.toLocaleString();
      };

      function resolveLeverage(position, fallbackLeverage = 0) {
        const lev = Number(position?.leverage ?? fallbackLeverage ?? 0);
        return Number.isFinite(lev) && lev > 0 ? lev : 0;
      }

      function resolveMargin(position, fallbackLeverage = 0) {
        const directMargin = Number(
          position?.margin ?? position?.usedMargin ?? position?.initialMargin ?? position?.isolatedMargin ?? 0,
        );
        if (Number.isFinite(directMargin) && directMargin > 0) return directMargin;

        const lev = resolveLeverage(position, fallbackLeverage);
        const directSize = Number(position?.size ?? position?.positionSize ?? position?.notional ?? 0);
        if (Number.isFinite(directSize) && directSize > 0 && lev > 0) return directSize / lev;

        const qty = Math.abs(Number(position?.positionAmt ?? position?.amount ?? position?.qty ?? 0));
        const px = Number(position?.entryPrice ?? position?.currentPrice ?? 0);
        if (qty > 0 && px > 0 && lev > 0) return (qty * px) / lev;

        return 0;
      }

      function resolveSize(position, fallbackLeverage = 0) {
        const directSize = Number(position?.size ?? position?.positionSize ?? position?.notional ?? 0);
        if (Number.isFinite(directSize) && directSize > 0) return directSize;
        const lev = resolveLeverage(position, fallbackLeverage);
        const margin = resolveMargin(position, fallbackLeverage);
        if (margin > 0 && lev > 0) return margin * lev;
        return 0;
      }

      async function fetchJson(path, options = {}) {
        const res = await fetch(path, options);
        let data;
        const text = await res.text();
        try {
          data = text ? JSON.parse(text) : {};
        } catch (e) {
          data = { detail: text || `HTTP ${res.status}` };
        }
        if (!res.ok) {
          throw new Error(data?.detail || `${res.status} ${path}`);
        }
        return data;
      }

      function renderTable(el, columns, rows) {
        if (!rows || !rows.length) {
          el.innerHTML = '<p class="muted">No open positions.</p>';
          return;
        }
        const head = columns.map((c) => `<th>${c}</th>`).join('');
        const body = rows.map((r) => `<tr>${r.map((x) => `<td>${x}</td>`).join('')}</tr>`).join('');
        el.innerHTML = `<div class="table-wrap"><table><thead><tr>${head}</tr></thead><tbody>${body}</tbody></table></div>`;
      }

      function renderResult(data, isError = false) {
        const rows = [];
        rows.push({ key: 'Success', value: data.success ? 'true' : 'false' });
        if (data.message) rows.push({ key: 'Message', value: data.message });
        if (typeof data.closed !== 'undefined') rows.push({ key: 'Closed', value: String(data.closed) });
        if (data.dry_run) rows.push({ key: 'Dry run', value: 'true' });
        if (data.code) rows.push({ key: 'Code', value: data.code });
        if (data.errors && data.errors.length) rows.push({ key: 'Errors', value: data.errors.join(' | ') });
        const html = rows
          .map((r) => `<div class="kv-row"><span>${r.key}</span><strong>${r.value}</strong></div>`)
          .join('');
        const container = document.getElementById('result');
        container.className = isError ? 'kv-list down' : 'kv-list';
        container.innerHTML = html;
      }

      async function refreshPositions() {
        const [data, status] = await Promise.all([fetchJson('/api/open-positions'), fetchJson('/api/status')]);
        const strategy = data.strategy_position || null;
        const manualPositions = Array.isArray(data.manual_positions) && data.manual_positions.length
          ? data.manual_positions
          : (data.manual_position ? [data.manual_position] : []);
        document.getElementById('strategy-state').textContent = `Strategy state: ${status.strategy_state || 'running'} | ${status?.strategy?.name || '-'}`;
        renderTable(
          document.getElementById('positions-strategy'),
          ['Coin', 'Side', 'Entry', 'Current', 'StopLoss', 'TP Price', 'Margin', 'Size', 'uPnL', 'Opened'],
          strategy
            ? [[
                strategy.coin || '-',
                strategy.side || '-',
                money(strategy.entryPrice),
                money(strategy.currentPrice),
                strategy.stopLoss ? money(strategy.stopLoss) : '-',
                strategy.takeProfit ? money(strategy.takeProfit) : '-',
                (() => {
                  const margin = resolveMargin(strategy, status?.strategy?.leverage || 0);
                  return margin > 0 ? `${money(margin)} BOKS` : '-';
                })(),
                (() => {
                  const size = resolveSize(strategy, status?.strategy?.leverage || 0);
                  return size > 0 ? `${money(size)} BOKS` : '-';
                })(),
                `${Number(strategy.unrealizedPnl || 0) >= 0 ? '+' : ''}${money(strategy.unrealizedPnl)} BOKS`,
                tsMs(strategy.openedAt),
              ]]
            : [],
        );
        renderTable(
          document.getElementById('positions-manual'),
          ['Coin', 'Side', 'Entry', 'Current', 'StopLoss', 'TP Price', 'Margin', 'Size', 'uPnL', 'Opened'],
          manualPositions.map((manual) => [
            manual.coin || '-',
            manual.side || '-',
            money(manual.entryPrice),
            money(manual.currentPrice),
            manual.stopLoss ? money(manual.stopLoss) : '-',
            manual.takeProfit ? money(manual.takeProfit) : '-',
            (() => {
              const margin = resolveMargin(manual, status?.strategy?.leverage || 0);
              return margin > 0 ? `${money(margin)} BOKS` : '-';
            })(),
            (() => {
              const size = resolveSize(manual, status?.strategy?.leverage || 0);
              return size > 0 ? `${money(size)} BOKS` : '-';
            })(),
            `${Number(manual.unrealizedPnl || 0) >= 0 ? '+' : ''}${money(manual.unrealizedPnl)} BOKS`,
            tsMs(manual.openedAt),
          ]),
        );

        const selector = document.getElementById('manual-close-position');
        selector.innerHTML = '';
        if (!manualPositions.length) {
          selector.innerHTML = '<option value="">No manual positions</option>';
        } else {
          selector.innerHTML = manualPositions
            .map((p) => {
              const pid = p.positionId || '';
              const coin = p.coin || '-';
              const entry = money(p.entryPrice);
              const margin = (() => {
                const v = resolveMargin(p, status?.strategy?.leverage || 0);
                return v > 0 ? money(v) : '-';
              })();
              return `<option value="${pid}">${pid} | ${coin} | entry ${entry} | margin ${margin}</option>`;
            })
            .join('');
        }
      }

      async function refreshStrategies() {
        const data = await fetchJson('/api/strategies');
        const items = Array.isArray(data.items) ? data.items : [];
        const active = (data.active || '').toUpperCase();
        const selector = document.getElementById('strategy-select');
        selector.innerHTML = items
          .map((s) => `<option value="${s.id}">${s.label}</option>`)
          .join('');
        if (items.some((s) => s.id === active)) {
          selector.value = active;
        }
        const picked = items.find((s) => s.id === selector.value);
        document.getElementById('strategy-entry-note').textContent = picked?.entry || '-';
        selector.onchange = () => {
          const current = items.find((s) => s.id === selector.value);
          document.getElementById('strategy-entry-note').textContent = current?.entry || '-';
        };
      }

      async function applyStrategy() {
        const btn = document.getElementById('btn-apply-strategy');
        btn.disabled = true;
        btn.textContent = 'Applying...';
        try {
          const strategyId = document.getElementById('strategy-select').value || '';
          const data = await fetchJson('/api/strategy/select', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ strategy_id: strategyId }),
          });
          renderResult({ success: true, message: `Strategy applied: ${data.active}` }, false);
          await refreshStrategies();
          await refreshPositions();
        } catch (e) {
          renderResult({ success: false, message: String(e) }, true);
        } finally {
          btn.disabled = false;
          btn.textContent = 'Apply Strategy';
        }
      }

      async function refreshSettings() {
        const cfg = await fetchJson('/api/bot/settings');
        document.getElementById('cfg-size').value = Number(cfg.margin_boks || 0).toFixed(2).replace(/\.00$/, '');
        document.getElementById('cfg-lev').value = Number(cfg.leverage || 0).toFixed(2).replace(/\.00$/, '');
        document.getElementById('cfg-sl').value = Number(cfg.sl_percent || 0).toFixed(2).replace(/\.00$/, '');
        document.getElementById('cfg-tp').value = Number(cfg.tp_percent || 0).toFixed(2).replace(/\.00$/, '');
        document.getElementById('manual-config-preview').textContent = `Margin ${Number(cfg.margin_boks || 0).toFixed(2)} BOKS | Leverage x${Number(cfg.leverage || 0).toFixed(2)} | SL ${Number(cfg.sl_percent || 0).toFixed(2)}% | TP ${Number(cfg.tp_percent || 0).toFixed(2)}%`;
      }

      async function saveSettings() {
        const btn = document.getElementById('btn-save-settings');
        btn.disabled = true;
        btn.textContent = 'Saving...';
        try {
          const payload = {
            margin_boks: Number(document.getElementById('cfg-size').value || 0),
            leverage: Number(document.getElementById('cfg-lev').value || 0),
            sl_percent: Number(document.getElementById('cfg-sl').value || 0),
            tp_percent: Number(document.getElementById('cfg-tp').value || 0),
          };
          const data = await fetchJson('/api/bot/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          renderResult({ success: true, message: 'Settings saved.', details: JSON.stringify(data.settings || {}) }, false);
          await refreshSettings();
        } catch (e) {
          renderResult({ success: false, message: String(e) }, true);
        } finally {
          btn.disabled = false;
          btn.textContent = 'Save Settings';
        }
      }

      async function forceOpen() {
        const btn = document.getElementById('btn-open');
        btn.disabled = true;
        btn.textContent = 'Opening...';
        try {
          const symbol = document.getElementById('manual-open-symbol').value || 'ETHUSDT';
          const data = await fetchJson('/api/manual/force-open-long', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ symbol }),
          });
          renderResult(data, !data.success);
          await refreshPositions();
        } catch (e) {
          renderResult({ success: false, message: String(e) }, true);
        } finally {
          btn.disabled = false;
          btn.textContent = 'OPEN Manual LONG Position';
        }
      }

      async function closePosition() {
        const positionId = document.getElementById('manual-close-position').value || '';
        if (!positionId) {
          renderResult({ success: false, message: 'Please select manual position first.' }, true);
          return;
        }
        if (!confirm(`Close manual position ${positionId}?`)) return;
        const btn = document.getElementById('btn-close');
        btn.disabled = true;
        btn.textContent = 'Closing...';
        try {
          const data = await fetchJson('/api/manual/close-position', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ position_id: positionId }),
          });
          renderResult(data, !data.success);
          await refreshPositions();
        } catch (e) {
          renderResult({ success: false, message: String(e) }, true);
        } finally {
          btn.disabled = false;
          btn.textContent = 'Manual Close Position';
        }
      }

      async function closeStrategyPosition() {
        if (!confirm('Close strategy ETHUSDT position?')) return;
        const btn = document.getElementById('btn-close-strategy');
        btn.disabled = true;
        btn.textContent = 'Closing Strategy...';
        try {
          const data = await fetchJson('/api/manual/close-strategy-position', { method: 'POST' });
          renderResult(data, !data.success);
          await refreshPositions();
        } catch (e) {
          renderResult({ success: false, message: String(e) }, true);
        } finally {
          btn.disabled = false;
          btn.textContent = 'Close Strategy Position';
        }
      }

      async function pauseStrategy() {
        const btn = document.getElementById('btn-pause');
        btn.disabled = true;
        btn.textContent = 'Pausing...';
        try {
          const data = await fetchJson('/api/bot/pause', { method: 'POST' });
          renderResult(data, !data.success);
          await refreshPositions();
        } catch (e) {
          renderResult({ success: false, message: String(e) }, true);
        } finally {
          btn.disabled = false;
          btn.textContent = 'Pause Running Bot';
        }
      }

      async function resumeStrategy() {
        const btn = document.getElementById('btn-resume');
        btn.disabled = true;
        btn.textContent = 'Resuming...';
        try {
          const data = await fetchJson('/api/bot/resume', { method: 'POST' });
          renderResult(data, !data.success);
          await refreshPositions();
        } catch (e) {
          renderResult({ success: false, message: String(e) }, true);
        } finally {
          btn.disabled = false;
          btn.textContent = 'Resume Bot';
        }
      }

      document.getElementById('btn-open').addEventListener('click', forceOpen);
      document.getElementById('btn-close').addEventListener('click', closePosition);
      document.getElementById('btn-close-strategy').addEventListener('click', closeStrategyPosition);
      document.getElementById('btn-pause').addEventListener('click', pauseStrategy);
      document.getElementById('btn-resume').addEventListener('click', resumeStrategy);
      document.getElementById('btn-save-settings').addEventListener('click', saveSettings);
      document.getElementById('btn-apply-strategy').addEventListener('click', applyStrategy);

      refreshPositions();
      refreshSettings();
      refreshStrategies();
      setInterval(refreshPositions, 5000);
      setInterval(refreshSettings, 15000);
      setInterval(refreshStrategies, 30000);
    </script>
  </body>
</html>
