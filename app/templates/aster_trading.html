<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AsterTrading - zzCatBoktoshiTradingBot</title>
    <link rel="stylesheet" href="/static/app.css" />
    <style>
      .aster-grid { display: grid; grid-template-columns: 1.2fr 1fr; gap: 16px; }
      .aster-inner { display: grid; grid-template-columns: repeat(2, minmax(260px, 1fr)); gap: 16px; }
      .acct-panel { background: linear-gradient(180deg, #111418 0%, #12161d 100%); border: 1px solid #2f333b; border-radius: 12px; padding: 16px; }
      .acct-actions { display: flex; gap: 8px; margin: 10px 0 14px; }
      .acct-btn { flex: 1; border: 1px solid #3a404c; background: #1b1f28; color: #dfc18b; border-radius: 8px; padding: 10px; font-weight: 700; }
      .acct-section-title { font-size: 26px; margin: 0; }
      .acct-subtitle { color: #b6c0cd; margin: 10px 0; font-size: 20px; }
      .acct-row { display: flex; justify-content: space-between; align-items: center; padding: 7px 0; border-bottom: 1px dashed rgba(255,255,255,.08); }
      .acct-row span { color: #9ea9b7; }
      .acct-row strong { color: #e7eef8; }
      .trade-panel { background: linear-gradient(180deg, #111418 0%, #111822 100%); border: 1px solid #2f333b; border-radius: 12px; padding: 16px; }
      .trade-tabs { display: flex; gap: 16px; border-bottom: 1px solid #2f333b; padding-bottom: 10px; margin-bottom: 14px; }
      .trade-tabs button { background: transparent; border: 0; color: #96a2b2; font-size: 28px; cursor: pointer; }
      .trade-tabs button.active { color: #ffffff; font-weight: 700; }
      .trade-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
      .trade-field { display: flex; flex-direction: column; gap: 6px; }
      .trade-field label { font-size: 12px; color: #9ea9b7; text-transform: uppercase; }
      .trade-field input, .trade-field select { background: #1e232c; color: #edf3fb; border: 1px solid #3a404c; border-radius: 8px; padding: 10px; font-size: 14px; }
      .trade-toggle { display: flex; align-items: center; gap: 8px; margin: 10px 0; color: #d3dceb; }
      .trade-quick { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 8px; margin: 12px 0; }
      .trade-quick div { border: 1px solid #333a48; border-radius: 8px; padding: 8px; background: #191d26; }
      .trade-quick span { display: block; color: #9ea9b7; font-size: 11px; text-transform: uppercase; }
      .trade-quick strong { font-size: 15px; }
      .aster-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
      .btn-long { background: linear-gradient(180deg, #6fc4be 0%, #56aba5 100%); color: #0f1a1f; border: 0; border-radius: 8px; padding: 12px; font-weight: 700; cursor: pointer; }
      .btn-close-aster { background: linear-gradient(180deg, #f29c62 0%, #d47434 100%); color: #27150a; border: 0; border-radius: 8px; padding: 12px; font-weight: 700; cursor: pointer; }
      .mono-box { border: 1px solid var(--line); border-radius: 10px; background: rgba(0,0,0,.18); padding: 10px; max-height: 240px; overflow: auto; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; }
      @media (max-width: 1100px) {
        .aster-grid { grid-template-columns: 1fr; }
      }
      @media (max-width: 720px) {
        .aster-inner { grid-template-columns: 1fr; }
        .trade-row { grid-template-columns: 1fr; }
        .trade-quick { grid-template-columns: 1fr 1fr; }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header class="header">
        <h1>AsterTrading</h1>
        <p>ASTER Futures manual trading panel for ETHUSDT.</p>
        <div class="nav-links">
          <a href="/">Dashboard</a>
          <a href="/manual">Manual Trade</a>
          <a href="/aster-chart">ASTER Chart</a>
          <a href="/aster-trading" class="active">AsterTrading</a>
          <a href="/chatlog">ChatLog</a>
        </div>
      </header>

      <section class="aster-grid">
        <div class="acct-panel">
          <h2 class="acct-section-title">Account</h2>
          <div class="acct-actions">
            <button class="acct-btn" type="button">Deposit</button>
            <button class="acct-btn" type="button">Withdraw</button>
            <button class="acct-btn" type="button">Transfer</button>
          </div>
          <h3 class="acct-subtitle">Account Equity</h3>
          <div id="acct-equity"></div>
          <h3 class="acct-subtitle" style="margin-top:14px;">Margin</h3>
          <div id="acct-margin"></div>
        </div>

        <div class="trade-panel">
          <div class="trade-tabs">
            <button class="active" data-type="MARKET" type="button">Market</button>
            <button data-type="LIMIT" type="button">Limit</button>
            <button data-type="STOP" type="button">Stop Limit</button>
          </div>

          <div class="trade-row">
            <div class="trade-field">
              <label>Pair</label>
              <input id="f-symbol" value="ETHUSDT" readonly />
            </div>
            <div class="trade-field">
              <label>Dry Run</label>
              <select id="f-dryrun">
                <option value="true">true</option>
                <option value="false">false</option>
              </select>
            </div>
          </div>

          <div class="trade-row">
            <div class="trade-field"><label>Leverage (x)</label><input id="f-leverage" type="number" min="1" max="125" value="5" /></div>
            <div class="trade-field"><label>Notional (USDT)</label><input id="f-notional" type="number" min="1" step="0.1" value="400" /></div>
          </div>

          <div class="trade-row">
            <div class="trade-field"><label>SL (%)</label><input id="f-sl" type="number" min="0.01" step="0.01" value="5" /></div>
            <div class="trade-field"><label>TP (%)</label><input id="f-tp" type="number" min="0" step="0.1" value="15" /></div>
          </div>

          <div class="trade-row">
            <div class="trade-field"><label>Limit Price</label><input id="f-price" type="number" min="0" step="0.01" placeholder="Only for limit/stop" /></div>
            <div class="trade-field"><label>Trigger Price</label><input id="f-trigger" type="number" min="0" step="0.01" placeholder="Stop trigger" /></div>
          </div>

          <div class="trade-row">
            <div class="trade-field">
              <label>Time In Force</label>
              <select id="f-tif">
                <option value="GTC">GTC</option>
                <option value="IOC">IOC</option>
                <option value="FOK">FOK</option>
              </select>
            </div>
            <div class="trade-field">
              <label>Direction</label>
              <select id="f-side">
                <option value="BUY">Long (BUY)</option>
                <option value="SELL">Short (SELL)</option>
              </select>
            </div>
          </div>

          <label class="trade-toggle"><input id="f-enable-tpsl" type="checkbox" checked /> TP/SL</label>
          <label class="trade-toggle"><input id="f-reduce-only" type="checkbox" /> Reduce-only</label>

          <div class="trade-quick">
            <div><span>Risk</span><strong id="q-risk">-</strong></div>
            <div><span>Margin</span><strong id="q-margin">-</strong></div>
            <div><span>Qty</span><strong id="q-qty">-</strong></div>
            <div><span>Mark</span><strong id="q-mark">-</strong></div>
          </div>

          <div class="aster-actions">
            <button id="btn-preview" class="btn btn-warning" type="button">Preview</button>
            <button id="btn-open" class="btn-long" type="button">Open Order</button>
            <button id="btn-close" class="btn-close-aster" type="button">Close Position</button>
          </div>
        </div>
      </section>

      <section class="aster-inner" style="margin-top: 16px;">
        <div class="card"><h2>Open Positions</h2><div id="open-positions">Loading...</div></div>
        <div class="card"><h2>Open Orders</h2><div id="open-orders">Loading...</div></div>
        <div class="card"><h2>Trade History</h2><div id="trade-history">Loading...</div></div>
        <div class="card"><h2>Income / PnL History</h2><div id="pnl-history">Loading...</div></div>
      </section>

      <section class="grid" style="margin-top: 16px;">
        <div class="card"><h2>Latest Response</h2><div id="response-box" class="mono-box">Idle</div></div>
      </section>
    </div>

    <script>
      const money = (n, max = 2) => Number(n || 0).toLocaleString('en-US', { maximumFractionDigits: max });
      let orderType = 'MARKET';

      async function fetchJson(path, options = {}) {
        const res = await fetch(path, options);
        if (!res.ok) {
          const txt = await res.text();
          throw new Error(`${res.status} ${txt}`);
        }
        return res.json();
      }

      function tableHtml(columns, rows) {
        if (!rows || !rows.length) return '<p class="muted">No data.</p>';
        const head = columns.map((c) => `<th>${c}</th>`).join('');
        const body = rows.map((r) => `<tr>${r.map((x) => `<td>${x}</td>`).join('')}</tr>`).join('');
        return `<div class="table-wrap"><table><thead><tr>${head}</tr></thead><tbody>${body}</tbody></table></div>`;
      }

      function formPayload() {
        return {
          side: document.getElementById('f-side').value,
          order_type: orderType,
          leverage: Number(document.getElementById('f-leverage').value || 5),
          notional_usdt: Number(document.getElementById('f-notional').value || 400),
          stop_loss_pct: Number(document.getElementById('f-sl').value || 5) / 100,
          take_profit_pct: Number(document.getElementById('f-tp').value || 15) / 100,
          price: Number(document.getElementById('f-price').value || 0),
          trigger_price: Number(document.getElementById('f-trigger').value || 0),
          time_in_force: document.getElementById('f-tif').value,
          reduce_only: document.getElementById('f-reduce-only').checked,
          enable_tpsl: document.getElementById('f-enable-tpsl').checked,
          dry_run: document.getElementById('f-dryrun').value === 'true',
        };
      }

      function renderAccount(data) {
        const eq = data.account_equity || {};
        const mg = data.margin || {};
        document.getElementById('acct-equity').innerHTML = [
          ['Spot total value', `${money(eq.spot_total_value)} USDT`],
          ['Perp total value', `${money(eq.perp_total_value)} USDT`],
          ['Perpetuals unrealized PnL', `${money(eq.perp_unrealized_pnl)} USDT`],
          ['Shield unrealized PnL', `${money(eq.shield_unrealized_pnl)} USDT`],
        ].map((r) => `<div class="acct-row"><span>${r[0]}</span><strong>${r[1]}</strong></div>`).join('');

        document.getElementById('acct-margin').innerHTML = [
          ['Account Margin Ratio', `${Number(mg.account_margin_ratio_pct || 0).toFixed(2)}%`],
          ['Account Maintenance Margin', `${money(mg.account_maintenance_margin)} USDT`],
          ['Account Equity', `${money(mg.account_equity)} USDT`],
          ['Wallet Balance', `${money(mg.wallet_balance)} USDT`],
          ['Available Balance', `${money(mg.available_balance)} USDT`],
        ].map((r) => `<div class="acct-row"><span>${r[0]}</span><strong>${r[1]}</strong></div>`).join('');
      }

      async function preview() {
        const payload = formPayload();
        const p = await fetchJson('/api/aster-trading/order-preview', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        document.getElementById('q-risk').textContent = `${money(p.risk_usdt)} USDT`;
        document.getElementById('q-margin').textContent = `${money(p.margin_usdt)} USDT`;
        document.getElementById('q-qty').textContent = money(p.quantity, 6);
        document.getElementById('q-mark').textContent = money(p.entry_price);
        document.getElementById('response-box').textContent = JSON.stringify(p, null, 2);
      }

      async function placeOrder() {
        const payload = formPayload();
        const res = await fetchJson('/api/aster-trading/place-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        document.getElementById('response-box').textContent = JSON.stringify(res, null, 2);
        await refreshTables();
      }

      async function closePosition() {
        const payload = { dry_run: document.getElementById('f-dryrun').value === 'true' };
        const res = await fetchJson('/api/aster-trading/close-position', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        document.getElementById('response-box').textContent = JSON.stringify(res, null, 2);
        await refreshTables();
      }

      async function refreshTables() {
        const [positions, orders, trades, pnl] = await Promise.all([
          fetchJson('/api/aster-trading/open-positions'),
          fetchJson('/api/aster-trading/open-orders'),
          fetchJson('/api/aster-trading/trade-history?limit=30'),
          fetchJson('/api/aster-trading/pnl-history?limit=30'),
        ]);

        document.getElementById('open-positions').innerHTML = tableHtml(
          ['Side', 'Amt', 'Entry', 'Mark', 'uPnL', 'Lev'],
          (positions.items || []).map((p) => [
            Number(p.positionAmt || 0) >= 0 ? 'LONG' : 'SHORT',
            money(p.positionAmt, 6),
            money(p.entryPrice),
            money(p.markPrice),
            money(p.unRealizedProfit),
            `x${p.leverage || '-'}`,
          ]),
        );

        document.getElementById('open-orders').innerHTML = tableHtml(
          ['ID', 'Type', 'Side', 'Price', 'Qty', 'Status'],
          (orders.items || []).slice(0, 30).map((o) => [o.orderId, o.type, o.side, money(o.price), money(o.origQty, 6), o.status]),
        );

        document.getElementById('trade-history').innerHTML = tableHtml(
          ['Time', 'Side', 'Price', 'Qty', 'Realized PnL', 'Fee'],
          (trades.items || []).map((t) => [
            new Date(Number(t.time || 0)).toLocaleString(),
            t.side,
            money(t.price),
            money(t.qty, 6),
            money(t.realizedPnl),
            money(t.commission),
          ]),
        );

        document.getElementById('pnl-history').innerHTML = tableHtml(
          ['Time', 'Type', 'Income', 'Asset', 'Info'],
          (pnl.items || []).map((i) => [
            new Date(Number(i.time || 0)).toLocaleString(),
            i.incomeType || '-',
            money(i.income),
            i.asset || '-',
            i.info || '-',
          ]),
        );
      }

      async function refreshAccount() {
        const overview = await fetchJson('/api/aster-trading/account-overview');
        renderAccount(overview);
        const defaults = overview?.config?.defaults || {};
        document.getElementById('f-leverage').value = defaults.leverage ?? 5;
        document.getElementById('f-notional').value = defaults.position_notional_usdt ?? 400;
        document.getElementById('f-sl').value = Number(defaults.stop_loss_pct || 0.05) * 100;
        document.getElementById('f-tp').value = Number(defaults.take_profit_pct || 0.15) * 100;
        document.getElementById('f-dryrun').value = defaults.dry_run ? 'true' : 'false';
      }

      function bindTabs() {
        document.querySelectorAll('.trade-tabs button').forEach((btn) => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.trade-tabs button').forEach((x) => x.classList.remove('active'));
            btn.classList.add('active');
            orderType = btn.dataset.type;
          });
        });
      }

      document.getElementById('btn-preview').addEventListener('click', () => preview().catch((e) => (document.getElementById('response-box').textContent = String(e))));
      document.getElementById('btn-open').addEventListener('click', () => placeOrder().catch((e) => (document.getElementById('response-box').textContent = String(e))));
      document.getElementById('btn-close').addEventListener('click', () => closePosition().catch((e) => (document.getElementById('response-box').textContent = String(e))));

      bindTabs();
      refreshAccount().then(preview).catch((e) => (document.getElementById('response-box').textContent = String(e)));
      refreshTables().catch((e) => (document.getElementById('response-box').textContent = String(e)));
      setInterval(() => refreshAccount().catch(() => {}), 6000);
      setInterval(() => refreshTables().catch(() => {}), 6000);
    </script>
  </body>
</html>
